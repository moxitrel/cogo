* INTRODUCTION
A stackless coroutine library written in pure C and C++.

* FEATURES
- Portable: pure C/C++
- Reenterable
- Small

* Getting Start
*** C++
#+BEGIN_SRC C++
//
// 1. Include header "coroutine.h"
//
#include "coroutine.h"
#include <stdio.h>

//
// 2. Define a class that inherit co_t
//
// Print 0x7ffee80:0, 0x7ffee80:1, ... 0x7ffee80:6
class PrintN : public co_t {
    //
    // Define local variables, parameters, return values for coroutine function
    //
    int i;

    //
    // 3. Override operator(), which has the type "void ()"
    //
    void operator()()
    {
        //
        // 4. Set coroutine begin
        //
        co_begin(33);       // 33: list the line numbers of co_return(), co_call(), co_sched(), i.e. the value of __LINE__
     // co_begin();         // you can omit line numbers if enable GNUC extension

        //
        // 5. User code (*** No stack variable allowed, use member variable instead ***)
        //
        for (i = 0; i < 7; i++) {
            printf("%p:%d\n", this, i);
            co_return();    // yield
        }

        //
        // 4. Set coroutine end
        //
        co_end();
    }
};

//
// 2. Define a class that inherit co_t
//
// Create 2 PrintN coroutine
class CoroutineExample : public co_t {
    //
    // Define local variables of coroutine function
    //
    PrintN coroutine1;
    PrintN coroutine2;

    //
    // 3. Override operator()
    //
    void operator()()
    {
        //
        // 4. Set coroutine begin
        //
        co_begin(68,69);
     // co_begin();

        //
        // 5. User code
        //
        co_sched(coroutine1);   // add coroutine1 to scheduler
        co_sched(coroutine2);   // add coroutine2 to scheduler

        //
        // 4. Set coroutine end
        //
        co_end();
    }
};

// 6. Use it
int main()
{
    // Run until finish all coroutines.
    // Output:
    //  0x8f0:0
    //  0x8f0:1
    //  0x918:0
    //  0x8f0:2
    //  0x918:1
    //  0x8f0:3
    //  ...
    CoroutineExample().run();
}
#+END_SRC

*** C
#+BEGIN_SRC C
//
// 1. 包含头文件 "coroutine.h"
//
#include "coroutine.h"

//
// 2. 定义协程结构，必须继承 co_t
//
typedef struct {
    //
    // 继承co_t (作为第1个字段)
    //
    co_t co;

    //
    // 声明协程的 局部变量, 返回值, ...
    //
    int value;  // 返回值
} nat_gen_t;    // 自然数生成器

//
// 3. 定义协程函数, 类型必须为 void (co_t *)
//
// 自然数生成器
void nat_gen(nat_gen_t *co)
{
    //
    // 4. 标识 协程开始
    //
    co_begin(co, 37);           // 37: 列出所有 co_return(), co_call(), co_sched() 所在的行号, 即 __LINE__ 的值
 // co_begin(co);               // 若开启GNUC扩展，可省略行号

    //
    // 5. 用户代码 (*** 不要使用局部变量, 无法被恢复; 定义到 struct 字段中 ***)
    //
    for (co->value = 0; ; co->value++) {
        co_return(co);          // 返回，下次被调用，从此处开始执行
    }

    //
    // 4. 标识 协程结束
    //
    co_end(co);
}
// 6. 定义构造器, 用 CO() 初始化 co_t 成员
#define NAT_GEN()   ((nat_gen_t){.co = CO(nat_gen),})

// 7. 使用
int main(void)
{
    // 初始化
    nat_gen_t ng = NAT_GEN();

    nat_gen(&ng);   // ng.value = 0
    nat_gen(&ng);   // ng.value = 1
    nat_gen(&ng);   // ng.value = 2

    return 0;
}
#+END_SRC

* API
*** C++
- co_begin (...)    : coroutine begin
- co_end   ()       : coroutine end
- co_return()       : yield
- co_call  (co_t &) : call another coroutine (block current coroutine)
- co_sched (co_t &) : add a coroutine to the scheduler to run

- obj.state() : return running state
                 0, ready
                >0, running
                <0, stop, coroutine is finished
- obj.run()   : loop running until finish all coroutines

*** C
- co_begin (co_t *, ...)    : coroutine begin
- co_end   (co_t *)         : coroutine end
- co_return(co_t *)         : yield
- co_call  (co_t *, co_t *) : call another coroutine (block current coroutine)
- co_sched (co_t *, co_t *) : add a coroutine to the scheduler to run

- co_state(co_t *)  : return running state
                       0, ready
                      >0, running
                      <0, stop, coroutine is finished
- co_run(co_t *)    : loop running until finish all coroutines

* SEE ALSO
- Coroutines in C (https://www.chiark.greenend.org.uk/~sgtatham/coroutines.html)
- Protothreads    (http://dunkels.com/adam/pt/)
